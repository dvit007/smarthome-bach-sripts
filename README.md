# Smarthome scripts
Скрипты на bach и других языках, которые я использую для автоматизации в Умном доме 

Здесь собраны скрипты, которые используются на серверах:
- master
- ubuntu16srv

Роутеры wifi:
 - Tomato (OpenWrt)
 - Mikrotik (Router OS 6)

Для каждого сервера, скрипты храняться в соответствующих папках. 
Они повторяют структуру каталогов на устройстве.

## Master сервер
### Скрипты для упраления вирутальными машинами QEMU
Расположение скриптов:
`etc/libvrt/hooks/`

**qemu**<br/>
Скрипт обеспечивает передачу информации в OH2 о состоняии гостевой ОС<br/>
и автоматическое ее отключение, по прошествии времени заданного в durationwork

Он вызывается автоматически службой libvirt.

Ему передаются параметры:
* `${1}` имя гостевой ОС
* `${2}` команда для этой виртуальки    

**shutdown_guest.sh**<br/>
Скрипт выключает гостевую ОС.

Он вызывается автоматически службой Cron. Задание Cron созадется в скрипте *qemu*

Ему передаются параметры:                                                        
* `${1}` имя гостевой ОС    

### Скрипты для управления UPS
Сервер подключен к ups Ippon. Скрипты автоматизируют выключение сервера при отключении электроэнерегии, и его автоматическому включению при возобновлении электроснабжения.<br/>
Перед отключением корректно завершается работа всех виртуальных машин. Что позволяет избежать потери данных из-за аварийного отключения.

Расположение настроек программы NUT для управления UPS:
`etc/nut/`

**nut.conf**,**ups.conf**,**upsd.conf**,**upsd.users**,**upsmon.conf**,**upssched.conf**

Расположение скриптов для управления UPS и сервером
`home/master/ups/`

**kvm_guest_shutdown.sh**<br/>
Скрипт реализующий корректное выключение гостевых ОС.<br/>
Он вызывается из скриптов службы NUT.

Ему передаются параметры:
* `--shutdown` отключение госетвых машин и выключение Хоста
* `--reboot` отключение гоствых машин и перезагрузка Хоста

**ups_host_start.sh**<br/>
**upssched-script.sh**<br/>

### Скрипты для управления USB ключами
Для предоставления безопасного доступа к ключам USB, используется специальная виртуальная машина *ubuntu16srv*.<br/>
Она по команде через Telegram включается и автоматически отключается через 30 минут.

В момент включения сервера подключаются usb ключи. При этом учитывается какие ключи доступны пользователю, который отправил команду через Telegram

**manage_usb.sh**<br/>
